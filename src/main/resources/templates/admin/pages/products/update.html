<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{admin/layouts/admin-layout}">

<head>
    <title>Sửa sản phẩm - FruitCart</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .image-preview {
            max-width: 100px;
            margin: 5px;
        }

        .thumb-upload {
            position: relative;
            margin-bottom: 10px;
        }

        .thumb-edit label {
            cursor: pointer;
        }

        .remove-thumb-btn {
            position: absolute;
            top: 0;
            right: 0;
        }
    </style>
</head>

<body>
    <div layout:fragment="content">
        <div class="row">
            <form th:action="@{/admin/products/edit/{id}(id=${product.id})}" method="post" enctype="multipart/form-data"
                th:object="${productUpdateDTO}">
                <div class="col-md-12">
                    <div class="cr-card card-default">
                        <div class="cr-card-content">
                            <div class="row cr-product-uploads">
                                <div class="col-lg-4 mb-991">
                                    <div class="cr-vendor-img-upload">
                                        <div class="cr-vendor-main-img">
                                            <div class="avatar-upload">
                                                <div class="avatar-edit">
                                                    <input type="file" id="product_main" class="cr-image-upload"
                                                        accept=".png, .jpg, .jpeg" name="mainImage">
                                                    <label for="product_main"><i class="ri-pencil-line"></i></label>
                                                </div>
                                                <div class="avatar-preview cr-preview">
                                                    <div class="imagePreview cr-div-preview">
                                                        <img class="cr-image-preview image-preview"
                                                            th:src="${product.images.?[isMain].size() > 0} ? @{/uploads/{image}(image=${product.images.?[isMain][0].imageUrl})} : @{/admin/assets/img/product/preview.jpg}"
                                                            alt="Main Image">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="thumb-upload-set col-md-12">
                                                <div class="thumb-upload-template" style="display: none;">
                                                    <div class="thumb-upload d-flex flex-column">
                                                        <div>
                                                            <div class="thumb-edit">
                                                                <input type="file" class="cr-image-upload thumb-input"
                                                                    accept=".png, .jpg, .jpeg">
                                                                <label><i class="ri-pencil-line"></i></label>
                                                            </div>
                                                            <div class="thumb-preview cr-preview">
                                                                <div class="image-thumb-preview">
                                                                    <img class="image-thumb-preview cr-image-preview image-preview"
                                                                        th:src="@{/admin/assets/img/product/preview.jpg}"
                                                                        alt="Sub Image">
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <button type="button"
                                                            class="btn btn-sm btn-danger remove-thumb-btn mt-1"
                                                            title="Xóa ảnh này">
                                                            <i class="ri-delete-bin-line"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <!-- Existing Sub Images -->
                                                <div th:each="image : ${product.images.?[!isMain]}"
                                                    class="thumb-upload d-flex flex-column">
                                                    <div>
                                                        <div class="thumb-edit">
                                                            <input type="file" class="cr-image-upload thumb-input"
                                                                th:id="'subImage' + ${image.id}"
                                                                accept=".png, .jpg, .jpeg"
                                                                th:name="'subImage_' + ${image.id}">
                                                            <label th:for="'subImage' + ${image.id}"><i
                                                                    class="ri-pencil-line"></i></label>
                                                        </div>
                                                        <div class="thumb-preview cr-preview">
                                                            <div class="image-thumb-preview">
                                                                <img class="image-thumb-preview cr-image-preview image-preview"
                                                                    th:src="@{/uploads/{image}(image=${image.imageUrl})}"
                                                                    alt="Sub Image">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <form
                                                        th:action="@{/admin/products/sub-image/delete/{imageId}(imageId=${image.id})}"
                                                        method="post" class="d-inline">
                                                        <input type="hidden" name="productId" th:value="${product.id}">
                                                        <button type="submit"
                                                            class="btn btn-sm btn-danger remove-thumb-btn mt-1"
                                                            title="Xóa ảnh này">
                                                            <i class="ri-delete-bin-line"></i>
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                            <button type="button" id="addThumbnailBtn"
                                                class="btn btn-outline-primary mt-3">
                                                <i class="ri-add-line"></i> Thêm ảnh con
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-8">
                                    <div class="cr-vendor-upload-detail">
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label for="name" class="form-label">Tên sản phẩm</label>
                                                <input type="text" class="form-control slug-title" id="name"
                                                    th:field="*{name}" th:value="${product.name}"
                                                    th:classappend="${#fields.hasErrors('name')} ? 'is-invalid' : ''">
                                                <div class="invalid-feedback" th:if="${#fields.hasErrors('name')}"
                                                    th:errors="*{name}"></div>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Chọn danh mục</label>
                                                <select class="form-control form-select" th:field="*{subcategoryId}"
                                                    th:classappend="${#fields.hasErrors('subcategoryId')} ? 'is-invalid' : ''">
                                                    <option value="">-- Chọn danh mục --</option>
                                                    <th:block th:each="category : ${categories}">
                                                        <optgroup
                                                            th:if="${category.subCategories != null and not #lists.isEmpty(category.subCategories)}"
                                                            th:label="${category.name}">
                                                            <th:block
                                                                th:each="subCategories : ${category.subCategories}">
                                                                <option th:if="${subCategories.active}"
                                                                    th:value="${subCategories.id}"
                                                                    th:text="${subCategories.name}"
                                                                    th:selected="${subCategories.id == product.subcategoryId}">
                                                                </option>
                                                            </th:block>
                                                        </optgroup>
                                                    </th:block>
                                                </select>
                                                <div class="invalid-feedback"
                                                    th:if="${#fields.hasErrors('subcategoryId')}"
                                                    th:errors="*{subcategoryId}"></div>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Giá cơ bản <span>(Việt Nam
                                                        đồng)</span></label>
                                                <input type="number" class="form-control" id="price1"
                                                    th:field="*{basePrice}" th:value="${product.price}"
                                                    th:classappend="${#fields.hasErrors('basePrice')} ? 'is-invalid' : ''">
                                                <div class="invalid-feedback" th:if="${#fields.hasErrors('basePrice')}"
                                                    th:errors="*{basePrice}"></div>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Trạng thái</label>
                                                <select class="form-control" th:field="*{active}">
                                                    <option value="true" th:selected="${product.active}">Hoạt động
                                                    </option>
                                                    <option value="false" th:selected="${not product.active}">Không hoạt
                                                        động</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Hàng thùng</label>
                                                <select class="form-control" th:field="*{bulk}">
                                                    <option value="true" th:selected="${product.bulk}">Có</option>
                                                    <option value="false" th:selected="${not product.bulk}">Không
                                                    </option>
                                                </select>
                                            </div>
                                            <div class="col-md-12">
                                                <label class="form-label">Mô tả</label>
                                                <textarea class="form-control" rows="4" th:field="*{description}"
                                                    th:text="${product.description}"></textarea>
                                            </div>
                                            <div class="col-md-12">
                                                <button class="cr-btn default-btn color-success" type="button"
                                                    id="addVariantBtn">
                                                    Tạo biến thể sản phẩm
                                                </button>
                                            </div>
                                            <div id="variantsContainer">
                                                <div class="variant-group row" th:each="variant, stat : *{variants}"
                                                    th:id="'variant-' + ${stat.index}">
                                                    <div class="col-md-5">
                                                        <label class="form-label">Thuộc tính</label>
                                                        <input type="text" class="form-control"
                                                            th:field="*{variants[__${stat.index}__].attribute}"
                                                            th:classappend="${#fields.hasErrors('variants[__${stat.index}__].attribute')} ? 'is-invalid' : ''" />
                                                        <div class="invalid-feedback"
                                                            th:if="${#fields.hasErrors('variants[__${stat.index}__].attribute')}"
                                                            th:errors="*{variants[__${stat.index}__].attribute}"></div>
                                                    </div>
                                                    <div class="col-md-5">
                                                        <label class="form-label">Giá:</label>
                                                        <input type="number" class="form-control"
                                                            th:field="*{variants[__${stat.index}__].price}"
                                                            th:classappend="${#fields.hasErrors('variants[__${stat.index}__].price')} ? 'is-invalid' : ''" />
                                                        <div class="invalid-feedback"
                                                            th:if="${#fields.hasErrors('variants[__${stat.index}__].price')}"
                                                            th:errors="*{variants[__${stat.index}__].price}"></div>
                                                    </div>
                                                    <div
                                                        class="col-md-2 d-flex justify-content-center align-items-center">
                                                        <button type="button" class="btn btn-danger"
                                                            th:onclick="|removeVariant(${stat.index})|">Xóa</button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-12">
                                                <button type="submit" class="btn cr-btn-primary">Lưu</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <th:block layout:fragment="extras-scripts">
        <script th:inline="javascript">
            $(document).ready(function () {
                // Add new sub-image input
                $("#addThumbnailBtn").click(function () {
                    let $newThumbUpload = $(".thumb-upload-template .thumb-upload").clone();
                    let $input = $newThumbUpload.find(".thumb-input");

                    $input.val('');
                    $input.attr('name', 'subImages');

                    let newId = 'thumbUpload' + ($(".thumb-upload-set .thumb-upload").length + 1);
                    $input.attr('id', newId);
                    $newThumbUpload.find('label').attr('for', newId);

                    $(".thumb-upload-set").append($newThumbUpload);
                    $newThumbUpload.show();

                    // Preview new sub-image
                    $input.on('change', function (e) {
                        const file = e.target.files[0];
                        if (file) {
                            const preview = $newThumbUpload.find('.image-thumb-preview img');
                            preview.attr('src', URL.createObjectURL(file));
                        }
                    });
                });

                // Remove new sub-image input
                $(".thumb-upload-set").on("click", ".remove-thumb-btn", function () {
                    $(this).closest(".thumb-upload").remove();
                });

                // Preview main image
                $("#product_main").on('change', function (e) {
                    const file = e.target.files[0];
                    if (file) {
                        $(".cr-vendor-main-img .cr-image-preview").attr('src', URL.createObjectURL(file));
                    }
                });

                // Preview existing sub-image updates
                $(".thumb-upload-set .thumb-input").on('change', function (e) {
                    const file = e.target.files[0];
                    if (file) {
                        $(this).closest('.thumb-upload').find('.image-thumb-preview img').attr('src', URL.createObjectURL(file));
                    }
                });
            });

            // Variant management
            let variantIndex = [[${ #lists.size(productUpdateDTO.variants) }]] || 0;
            $('#addVariantBtn').on('click', function () {
                const newIndex = variantIndex++;
                const newVariantHtml = `
                    <div class="variant-group row" id="variant-${newIndex}">
                        <div class="col-md-5">
                            <label class="form-label">Thuộc tính</label>
                            <input class="form-control" type="text" name="variants[${newIndex}].attribute" />
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label">Giá:</label>
                            <input class="form-control" type="number" name="variants[${newIndex}].price" />
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-md-2 d-flex justify-content-center align-items-center">
                            <button class="btn btn-danger" type="button" onclick="removeVariant(${newIndex})">Xóa</button>
                        </div>
                    </div>
                `;
                $('#variantsContainer').append(newVariantHtml);
            });

            function removeVariant(index) {
                $('#variant-' + index).remove();
            }
        </script>
    </th:block>
</body>

</html>