<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" lang="vi" dir="ltr">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title layout:title-pattern="$CONTENT_TITLE | Fruitcart" :>Default Title</title>

    <link rel="shortcut icon" th:href="@{/client/assets/img/favicon/favicon.ico}">
    <link rel="shortcut icon" th:href="@{/client/assets/img/favicon/favicon.ico}">

    <!-- Icon CSS -->
    <link th:href="@{/client/assets/css/vendor/materialdesignicons.min.css}" rel="stylesheet">
    <link th:href="@{/client/assets/css/vendor/remixicon.css}" rel="stylesheet">

    <!-- Vendor CSS -->
    <link rel="stylesheet" th:href="@{/shared/assets/css/vendor/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/client/assets/css/vendor/animate.css}">
    <link rel="stylesheet" th:href="@{/client/assets/css/vendor/aos.min.css}">
    <link rel="stylesheet" th:href="@{/client/assets/css/vendor/range-slider.css}">
    <link rel="stylesheet" th:href="@{/client/assets/css/vendor/swiper-bundle.min.css}">
    <link rel="stylesheet" th:href="@{/client/assets/css/vendor/jquery.slick.css}">
    <link rel="stylesheet" th:href="@{/client/assets/css/vendor/slick-theme.css}">

    <!-- Main CSS -->
    <link id="main-css" th:href="@{/client/assets/css/style.css}" rel="stylesheet">

</head>

<body>
    <!-- Loader -->
    <div id="cr-overlay">
        <span class="loader"></span>
    </div>

    <!-- Header -->
    <header th:replace="~{client/fragments/header :: header}"></header>

    <!-- Mobile menu -->
    <div th:replace="~{client/fragments/mobile-menu :: div}"></div>

    <th:block th:unless="${hideBreadcrumb}">
        <div th:replace="~{client/fragments/breadcrumb :: div}"></div>
    </th:block>

    <div layout:fragment="content"></div>

    <!-- Footer -->
    <footer th:replace="~{client/fragments/footer :: footer}"></footer>

    <!-- Tab to top -->
    <a th:replace="~{client/fragments/to-top :: a}"></a>

    <!-- Modal -->
    <div th:replace="~{client/fragments/modal :: div}"></div>

    <!-- Cart -->
    <div th:replace="~{client/fragments/cart :: div}"></div>


    <!-- Vendor Custom -->
    <script th:src="@{/shared/assets/js/vendor/jquery-3.6.4.min.js}"></script>
    <script th:src="@{/shared/assets/js/vendor/bootstrap.bundle.min.js}"></script>
    <script th:src="@{/shared/assets/js/vendor/sweetalert2.min.js}"></script>
    <script th:src="@{/client/assets/js/vendor/jquery.zoom.min.js}"></script>
    <script th:src="@{/client/assets/js/vendor/mixitup.min.js}"></script>
    <script th:src="@{/client/assets/js/vendor/range-slider.js}"></script>
    <script th:src="@{/client/assets/js/vendor/aos.min.js}"></script>
    <script th:src="@{/client/assets/js/vendor/swiper-bundle.min.js}"></script>
    <script th:src="@{/client/assets/js/vendor/slick.min.js}"></script>

    <!-- Main Custom -->
    <script th:src="@{/client/assets/js/main.js}"></script>
    <script th:src="@{/shared/assets/js/swal-utils.js}"></script>

    <th:block layout:fragment="extras-scripts"></th:block>

    <script th:inline="javascript">
        const message = /*[[${message}]]*/ null;
        const messageType = /*[[${messageType}]]*/ 'success';

        console.log(messageType)

        if (message) {
            showToast(message, messageType);
            console.log(message);
        }
    </script>

    <script>
        $(document).ready(function () {

            // Hàm để tải và hiển thị dữ liệu giỏ hàng
            function loadAndRenderSidebarCart() {
                fetch('/cart/summary')
                    .then(response => response.json())
                    .then(data => {
                        const itemsList = $('#sidebar-cart-items-list');
                        const grandTotalEl = $('#sidebar-cart-grand-total');
                        // Giả sử bạn có một thẻ span ở header để đếm số lượng
                        const cartCountBadge = $('#header-cart-count');

                        itemsList.empty(); // Xóa các mục cũ

                        if (data && data.items && data.items.length > 0) {
                            // Nếu có sản phẩm
                            data.items.forEach(item => {
                                const itemHtml = `
                                    <li>
                                        <a href="/products/${item.id}" class="crside_pro_img">
                                            <img src="${item.imgUrl}" alt="${item.name}">
                                        </a>
                                        <div class="cr-pro-content">
                                            <a href="/products/${item.id}" class="cart_pro_title">${item.name}</a>
                                            <span class="cart-price">
                                                <span>${new Intl.NumberFormat('vi-VN').format(item.totalPrice)} VND</span> x ${item.quantity}
                                            </span>
                                            <p style="font-size: 12px; margin: 0;"><em>${item.attribute}</em></p>
                                            
                                            <a href="javascript:void(0)" class="remove-from-cart" data-cart-item-id="${item.itemId}" title="Xóa sản phẩm">×</a>

                                        </div>
                                    </li>
                                `;
                                itemsList.append(itemHtml);
                            });

                            grandTotalEl.text(new Intl.NumberFormat('vi-VN').format(data.totalPrice) + ' VND');
                            if (cartCountBadge.length) cartCountBadge.text(data.totalItems);

                        } else {
                            // Nếu giỏ hàng trống
                            itemsList.html('<li><p class="text-center p-3">Giỏ hàng của bạn đang trống.</p></li>');
                            grandTotalEl.text('0 VND');
                            if (cartCountBadge.length) cartCountBadge.text('0');
                        }
                    })
                    .catch(error => {
                        console.error('Lỗi khi tải giỏ hàng:', error);
                    });
            }

            // Lắng nghe sự kiện để làm mới giỏ hàng từ bất kỳ đâu
            $(document).on('refreshCart', function () {
                loadAndRenderSidebarCart();
            });

            $('#sidebar-cart-items-list').on('click', '.remove-from-cart', function (event) {
                event.preventDefault();

                // Lấy ra thẻ <li> cha để xóa khỏi giao diện nếu thành công
                const cartItemElement = $(this).closest('li');

                // Lấy cartItemId từ thuộc tính data-
                const cartItemId = $(this).data('cart-item-id');

                console.log(cartItemId);

                if (!cartItemId) {
                    console.error('Không tìm thấy cartItemId để xóa.');
                    return;
                }

                // Sử dụng jQuery AJAX để gọi API của bạn
                $.ajax({
                    url: 'cart/remove/' + cartItemId, // Xây dựng URL với cartItemId
                    type: 'POST', // Phương thức khớp với @PostMapping ở backend
                    success: function (response) {
                        // Hàm này sẽ chạy khi API trả về status 200 OK
                        if (response.success) {
                            // Hiển thị thông báo thành công
                            if (typeof showSuccessToast === 'function') {
                                showSuccessToast(response.message);
                            } else {
                                alert(response.message);
                            }

                            // Cập nhật giao diện mà không cần tải lại toàn bộ giỏ hàng
                            // 1. Xóa dòng sản phẩm khỏi danh sách
                            cartItemElement.remove();

                            // 2. Cập nhật tổng tiền và số lượng từ response của API
                            $('#sidebar-cart-grand-total').text(new Intl.NumberFormat('vi-VN').format(response.totalPrice) + ' VND');
                            $('#header-cart-count').text(response.itemCount); // Giả sử id của badge đếm là header-cart-count

                            // Kiểm tra nếu giỏ hàng trống thì hiển thị thông báo
                            if (response.itemCount === 0) {
                                $('#sidebar-cart-items-list').html('<li><p class="text-center p-3">Giỏ hàng của bạn đang trống.</p></li>');
                            }

                        } else {
                            // Xử lý lỗi logic từ server (ví dụ: sản phẩm không tồn tại)
                            if (typeof showErrorAlert === 'function') {
                                showErrorAlert(response.message);
                            } else {
                                alert(response.message);
                            }
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        // Hàm này sẽ chạy khi có lỗi mạng hoặc server trả về lỗi (403, 404, 500)
                        console.error("Lỗi AJAX:", textStatus, errorThrown);
                        let errorMessage = 'Có lỗi xảy ra khi xóa sản phẩm.';

                        // Cố gắng lấy message lỗi từ server nếu có
                        if (jqXHR.responseJSON && jqXHR.responseJSON.message) {
                            errorMessage = jqXHR.responseJSON.message;
                        }

                        if (typeof showErrorAlert === 'function') {
                            showErrorAlert(errorMessage);
                        } else {
                            alert(errorMessage);
                        }
                    }
                });
            });



            // Tải giỏ hàng ngay khi trang được mở
            loadAndRenderSidebarCart();
        });
    </script>
</body>

</html>